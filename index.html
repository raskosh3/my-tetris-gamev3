<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–µ—Ç—Ä–∏—Å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;touch-action:manipulation;}
        body{background:#000;color:#fff;font-family:Arial;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
        .wrap{max-width:400px;margin:0 auto;width:100%;padding:10px 8px;display:flex;flex-direction:column;height:100%;}
        .header{background:rgba(255,255,255,0.1);padding:10px;border-radius:12px;display:flex;justify-content:space-between;font-size:14px;}
        .game-area{display:flex;gap:10px;margin-top:8px;}
        canvas{background:#111;border:3px solid #333;border-radius:10px;image-rendering:pixelated;}
        #tetris{flex:1;}
        .side{width:88px;display:flex;flex-direction:column;gap:8px;}
        .next{background:rgba(255,255,255,0.1);border-radius:10px;padding:6px;text-align:center;font-size:12px;}
        #next{width:76px;height:76px;background:#000;margin:4px auto 0;display:block;}
        .controls{margin-top:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
        .btn{background:rgba(255,255,255,0.18);border:2px solid rgba(255,255,255,0.35);border-radius:12px;height:52px;font-size:26px;display:flex;align-items:center;justify-content:center;}
        .btn:active{background:rgba(255,255,255,0.45);transform:scale(0.94);}
        .drop{grid-column:1/5;background:#c62828 !important;font-size:15px;height:48px;}
        .go{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:999;justify-content:center;align-items:center;padding:20px;}
        .gobox{background:rgba(255,255,255,0.12);padding:30px;border-radius:20px;text-align:center;max-width:340px;width:100%;backdrop-filter:blur(12px);}
        input{width:100%;padding:14px;margin:14px 0;border:none;border-radius:12px;font-size:18px;text-align:center;background:rgba(255,255,255,0.9);color:#000;}
        .copy-section{display:none;margin-top:15px;padding:15px;background:rgba(255,255,255,0.1);border-radius:12px;text-align:center;}
        .copy-text{background:rgba(255,255,255,0.9);color:#000;padding:12px;border-radius:8px;margin:10px 0;font-family:monospace;font-size:14px;}
        .copy-btn{background:#2196F3;color:white;border:none;padding:12px;border-radius:8px;width:100%;font-size:16px;}
    </style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <div>–û—á–∫–∏: <b id="score">0</b></div>
        <div>–£—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
        <div>–õ–∏–Ω–∏–∏: <b id="lines">0</b></div>
    </div>
    <div class="game-area">
        <canvas id="tetris"></canvas>
        <div class="side">
            <div class="next">–°–ª–µ–¥—É—é—â–∞—è<br><canvas id="next"></canvas></div>
        </div>
    </div>
    <div class="controls">
        <div class="btn">‚Üª</div>
        <div class="btn">‚Üê</div>
        <div class="btn">‚Üì</div>
        <div class="btn">‚Üí</div>
        <div class="btn drop">–ë–´–°–¢–†–û –í–ù–ò–ó</div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div class="copy-section" id="copy-section">
        <div style="margin-bottom:10px;">üìã –°–∫–æ–ø–∏—Ä—É–π –∏ –æ—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É:</div>
        <div class="copy-text" id="result-text"></div>
        <button class="copy-btn" id="copy-btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        <div style="margin-top:10px;font-size:12px;opacity:0.7;">–û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±–æ—Ç—É @raskosh3_bot</div>
    </div>
</div>

<div class="go" id="go">
    <div class="gobox">
        <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
        <h3>–û—á–∫–∏: <span id="final">0</span></h3>
        <input type="text" id="name" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="18">
        <p style="margin-top:18px;opacity:0.7;font-size:14px;">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
    </div>
</div>

<script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }
    const TOKEN = "7774913864:AAFLyQP6kuVmPcGYKgHOE9YpWJ2G7tGq3JU";
    const UID = tg?.initDataUnsafe?.user?.id || "unknown";

    const W = 10, H = 20, S = 26;
    const c = document.getElementById('tetris'); 
    const ctx = c.getContext('2d');
    c.width = W * S; 
    c.height = H * S;
    
    const nc = document.getElementById('next'); 
    const nctx = nc.getContext('2d');
    nc.width = nc.height = 76;

    const COLORS = ["#00ffff","#ffff00","#aa00ff","#00ff00","#ff0000","#0000ff","#ffaa00"];
    const SHAPES = [[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];

    let board = Array.from({length:H}, () => Array(W).fill(0));
    let p, np, score = 0, lines = 0, level = 1;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–≥—Ä–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    function generateGameToken(score, lines, level) {
        const secret = "tetris_verification_2024";
        const timestamp = Math.floor(Date.now() / 60000); // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –º–∏–Ω—É—Ç
        const data = `${score}:${lines}:${level}:${timestamp}:${secret}`;
        
        // –ü—Ä–æ—Å—Ç–∞—è —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏—è (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –≤ –±–æ—Ç–µ)
        let hash = 0;
        for (let i = 0; i < data.length; i++) {
            const char = data.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash).toString(16).substring(0, 8);
    }

    function npiece() {
        const i = Math.floor(Math.random() * SHAPES.length);
        return {x:4, y:0, s:SHAPES[i], c:COLORS[i]};
    }
    p = npiece(); 
    np = npiece();

    function drawBoard() {
        ctx.fillStyle = "#000"; 
        ctx.fillRect(0, 0, c.width, c.height);
        for (let y = 0; y < H; y++) 
            for (let x = 0; x < W; x++) 
                if (board[y][x]) {
                    ctx.fillStyle = board[y][x];
                    ctx.fillRect(x * S, y * S, S, S);
                    ctx.strokeStyle = "#222"; 
                    ctx.strokeRect(x * S, y * S, S, S);
                }
    }

    function drawP(p) {
        p.s.forEach((r, y) => r.forEach((v, x) => {
            if (v) {
                ctx.fillStyle = p.c;
                ctx.fillRect((p.x + x) * S, (p.y + y) * S, S, S);
                ctx.strokeStyle = "#222"; 
                ctx.strokeRect((p.x + x) * S, (p.y + y) * S, S, S);
            }
        }));
    }

    function drawNext() {
        nctx.fillStyle = "#000"; 
        nctx.fillRect(0, 0, 76, 76);
        np.s.forEach((r, y) => r.forEach((v, x) => {
            if (v) {
                nctx.fillStyle = np.c;
                nctx.fillRect(x * 19 + 10, y * 19 + 10, 18, 18);
            }
        }));
    }

    function collide(dx = 0, dy = 0) {
        return p.s.some((r, y) => r.some((v, x) => v && (
            p.x + x + dx < 0 || p.x + x + dx >= W || p.y + y + dy >= H || board[p.y + y + dy][p.x + x + dx]
        )));
    }

    function lock() {
        p.s.forEach((r, y) => r.forEach((v, x) => {
            if (v && p.y + y >= 0) board[p.y + y][p.x + x] = p.c;
        }));
        let cl = 0;
        for (let y = H - 1; y >= 0; y--) 
            if (board[y].every(v => v)) {
                board.splice(y, 1); 
                board.unshift(Array(W).fill(0)); 
                cl++; 
            }
        if (cl) {
            score += [100, 300, 500, 800][cl - 1] * level; 
            lines += cl; 
            if (lines >= level * 10) level++;
        }
        document.getElementById('score').textContent = score;
        document.getElementById('lines').textContent = lines;
        document.getElementById('level').textContent = level;
        p = np; 
        np = npiece(); 
        drawNext();
        if (collide()) end();
    }

    function drop() {
        if (!collide(0, 1)) p.y++; 
        else lock(); 
        draw();
    }

    function hard() {
        while (!collide(0, 1)) p.y++; 
        lock(); 
        draw();
    }

    // –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ë–û–¢–£
    async function sendScore() {
        const playerName = (document.getElementById('name').value || "–ê–Ω–æ–Ω–∏–º").trim().slice(0, 18);
        const gameToken = generateGameToken(score, lines, level);
        
        console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–æ—Ç—É:", { playerName, score, lines, level, token: gameToken });

        try {
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É
            const scoreMessage = `üèÜ –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–¢–†–ò–° üèÜ\n\n–ò–≥—Ä–æ–∫: ${playerName}\n–û—á–∫–∏: ${score}\n–õ–∏–Ω–∏–∏: ${lines}\n–£—Ä–æ–≤–µ–Ω—å: ${level}\n–¢–æ–∫–µ–Ω: ${gameToken}\nID: ${UID}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}\n\nüìã –û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É @raskosh3_bot —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç!`;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –±–æ—Ç–∞
            await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: "POST", 
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    chat_id: UID,
                    text: scoreMessage,
                    parse_mode: "Markdown"
                })
            });

            console.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
            
            alert(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç!\n\nüìã –°–∫–æ–ø–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –±–æ—Ç—É —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.`);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–≥—Ä—É
            if (tg?.MainButton) {
                tg.MainButton.setText("‚úÖ –ì–æ—Ç–æ–≤–æ!");
                setTimeout(() => tg.close?.(), 3000);
            } else {
                setTimeout(() => {
                    document.getElementById('go').style.display = 'none';
                }, 3000);
            }

        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
            
            // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const gameToken = generateGameToken(score, lines, level);
            const resultText = `üèÜ –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–ï–¢–†–ò–° üèÜ\n\n–ò–≥—Ä–æ–∫: ${playerName}\n–û—á–∫–∏: ${score}\n–õ–∏–Ω–∏–∏: ${lines}\n–£—Ä–æ–≤–µ–Ω—å: ${level}\n–¢–æ–∫–µ–Ω: ${gameToken}\nID: ${UID}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±–æ—Ç—É @raskosh3_bot`;
            document.getElementById('result-text').textContent = resultText;
            document.getElementById('copy-section').style.display = 'block';
            document.getElementById('go').style.display = 'none';
            
            alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –≤—Ä—É—á–Ω—É—é.");
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('copy-btn').addEventListener('click', async function() {
        const text = document.getElementById('result-text').textContent;
        try {
            await navigator.clipboard.writeText(text);
            this.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                this.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç';
            }, 2000);
        } catch (err) {
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            this.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                this.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç';
            }, 2000);
        }
    });

    function end() {
        document.getElementById('final').textContent = score;
        document.getElementById('go').style.display = 'flex';
        if (tg?.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('name').value = u.username ? `@${u.username}` : u.first_name;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ Telegram
        if (tg?.MainButton) {
            tg.MainButton.setText(`üì§ –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç`);
            tg.MainButton.color = "#40b345";
            tg.MainButton.show();
            tg.MainButton.onClick(sendScore);
        } else {
            // –ï—Å–ª–∏ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                const sendBtn = document.createElement('button');
                sendBtn.textContent = `üì§ –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç`;
                sendBtn.style.cssText = 'width:100%;padding:14px;background:#40b345;color:white;border:none;border-radius:12px;font-size:16px;margin-top:10px;';
                sendBtn.onclick = sendScore;
                document.querySelector('.gobox').appendChild(sendBtn);
            }, 500);
        }
    }

    document.querySelectorAll('.btn')[0].ontouchstart = e => {
        e.preventDefault();
        const s = p.s;
        p.s = s[0].map((_, i) => s.map(r => r[i]).reverse());
        if (collide()) p.s = s;
        draw();
    };
    document.querySelectorAll('.btn')[1].ontouchstart = e => {
        e.preventDefault();
        if (!collide(-1, 0)) p.x--; 
        draw();
    };
    document.querySelectorAll('.btn')[2].ontouchstart = e => {
        e.preventDefault(); 
        drop();
    };
    document.querySelectorAll('.btn')[3].ontouchstart = e => {
        e.preventDefault();
        if (!collide(1, 0)) p.x++; 
        draw();
    };
    document.querySelector('.drop').ontouchstart = e => {
        e.preventDefault(); 
        hard();
    };

    function draw() {
        drawBoard(); 
        drawP(p);
    }

    draw(); 
    drawNext();
    setInterval(() => {
        if (document.getElementById('go').style.display === 'flex') return;
        drop();
    }, 750 / level);
</script>
</body>
</html>
