<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тетрис Классика</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin:0; background:#000; color:white; font-family:Arial; height:100vh; display:flex; flex-direction:column; }
        .container { flex:1; display:flex; flex-direction:column; max-width:500px; margin:0 auto; width:100%; padding:10px; gap:10px; }
        .score { display:flex; justify-content:space-between; background:rgba(255,255,255,0.1); padding:10px; border-radius:12px; font-size:14px; }
        .game { position:relative; background:#111; border-radius:12px; overflow:hidden; }
        canvas { display:block; width:100%; height:auto; image-rendering:pixelated; }
        .next { background:rgba(255,255,255,0.1); padding:10px; border-radius:12px; text-align:center; }
        .controls { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .btn { background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3); border-radius:12px; height:60px; font-size:28px; display:flex; align-items:center; justify-content:center; }
        .btn:active { background:rgba(255,255,255,0.4); transform:scale(0.95); }
        .hard { grid-column:1/5; background:#d32f2f; font-size:16px; }
        .game-over { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:999; justify-content:center; align-items:center; padding:20px; }
        .go { background:rgba(255,255,255,0.1); padding:30px; border-radius:20px; text-align:center; max-width:380px; width:100%; backdrop-filter:blur(10px); }
        input { width:100%; padding:15px; margin:15px 0; border:none; border-radius:12px; font-size:18px; text-align:center; }
    </style>
</head>
<body>
<div class="container">
    <div class="score">
        <div>Очки: <b id="s">0</b></div>
        <div>Линии: <b id="l">0</b></div>
        <div>Уровень: <b id="lv">1</b></div>
    </div>
    <div class="game">
        <canvas id="board"></canvas>
    </div>
    <div class="next">Следующая:<br><canvas id="next" width="120" height="80"></canvas></div>
    <div class="controls">
        <div class="btn" id="left">←</div>
        <div class="btn" id="down">↓</div>
        <div class="btn" id="right">→</div>
        <div class="btn" id="rot">↻</div>
        <div class="btn hard" id="drop">БЫСТРО ВНИЗ</div>
    </div>
</div>

<div class="game-over" id="go">
    <div class="go">
        <h2>Игра окончена!</h2>
        <h3>Очки: <span id="final">0</span></h3>
        <input type="text" id="name" placeholder="Твоё имя" maxlength="20">
        <p style="margin-top:20px; opacity:0.7;">Нажми зелёную кнопку внизу</p>
    </div>
</div>

<script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const TOKEN = "7774913864:AAFLyQP6kuVmPcGYKgHOE9YpWJ2G7tGq3JU";
    const UID = tg?.initDataUnsafe?.user?.id || "unknown";

    const W = 10, H = 20, S = 30;
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');
    canvas.width = W*S; canvas.height = H*S;

    const nextC = document.getElementById('next');
    const nctx = nextC.getContext('2d');

    const COLORS = ['#00ffff','#ffff00','#aa00ff','#00ff00','#ff0000','#0000ff','#ffaa00'];
    const PIECES = [
        [[1,1,1,1]],                     // I
        [[1,1],[1,1]],                   // O
        [[0,1,0],[1,1,1]],               // T
        [[0,1,1],[1,1,0]],               // S
        [[1,1,0],[0,1,1]],               // Z
        [[1,0,0],[1,1,1]],               // J
        [[0,0,1],[1,1,1]]                // L
    ];

    let board = Array.from({length:H},()=>Array(W).fill(0));
    let piece, next, score=0, lines=0, level=1, gameOver=false;

    function newPiece() {
        const i = Math.floor(Math.random()*PIECES.length);
        return {x:4, y:0, shape:PIECES[i], color:COLORS[i]};
    }
    piece = newPiece(); next = newPiece();

    function drawBoard() {
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        for(let y=0;y<H;y++) for(let x=0;x<W;x++) if(board[y][x]) {
            ctx.fillStyle = board[y][x];
            ctx.fillRect(x*S,y*S,S,S);
            ctx.strokeStyle = '#333'; ctx.strokeRect(x*S,y*S,S,S);
        }
    }

    function drawPiece(p, c=ctx, offX=0, offY=0) {
        c.fillStyle = p.color;
        p.shape.forEach((row,dy)=>row.forEach((v,dx)=>{
            if(v) c.fillRect((p.x+dx+offX)*S, (p.y+dy+offY)*S, S, S);
            c.strokeStyle = '#333'; c.strokeRect((p.x+dx+offX)*S, (p.y+dy+offY)*S, S, S);
        }));
    }

    function collide(p=piece, dx=0, dy=0) {
        return p.shape.some((row,y)=>row.some((v,x)=>
            v && (p.x+x+dx<0 || p.x+x+dx>=W || p.y+y+dy>=H || board[p.y+y+dy]?.[p.x+x+dx])
        ));
    }

    function lock() {
        piece.shape.forEach((row,y)=>row.forEach((v,x)=>{
            if(v && piece.y+y>=0) board[piece.y+y][piece.x+x] = piece.color;
        }));
        let cleared = 0;
        for(let y=H-1; y>=0; y--) if(board[y].every(v=>v)) {
            board.splice(y,1); board.unshift(Array(W).fill(0)); cleared++; y++;
        }
        if(cleared) {
            score += [100,300,500,800][cleared-1] * level;
            lines += cleared;
            if(lines >= level*10) level++;
            document.getElementById('s').textContent = score;
            document.getElementById('l').textContent = lines;
            document.getElementById('lv').textContent = level;
        }
        piece = next; next = newPiece();
        drawNext();
        if(collide()) { gameOver=true; showGO(); }
    }

    function drop() { if(!collide(piece,0,1)) piece.y++; else lock(); draw(); }
    function hardDrop() { while(!collide(piece,0,1)) piece.y++; lock(); draw(); }

    function drawNext() {
        nctx.fillStyle = '#000'; nctx.fillRect(0,0,120,80);
        drawPiece(next, nctx, 1, 0);
    }

    function draw() { drawBoard(); drawPiece(piece); }

    document.getElementById('left').ontouchstart = () => { if(!collide(piece,-1,0)) piece.x--; draw(); };
    document.getElementById('right').ontouchstart = () => { if(!collide(piece,1,0)) piece.x++; draw(); };
    document.getElementById('down').ontouchstart = drop;
    document.getElementById('rot').ontouchstart = () => {
        const prev = piece.shape;
        piece.shape = prev[0].map((_,i)=>prev.map(r=>r[i]).reverse());
        if(collide()) piece.shape = prev;
        draw();
    };
    document.getElementById('drop').ontouchstart = hardDrop;

    function showGO() {
        document.getElementById('final').textContent = score;
        document.getElementById('go').style.display = 'flex';
        if(tg?.initDataUnsafe?.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('name').value = u.username ? `@${u.username}` : u.first_name;
        }

        const send = async () => {
            const name = (document.getElementById('name').value||"Аноним").trim().slice(0,20);
            const msg = `НОВЫЙ РЕКОРД ТЕТРИС\n\nИгрок: ${name}\nОчки: ${score}\nID: ${UID}`;

            await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({chat_id: UID, text: msg, parse_mode: "Markdown"})
            });

            tg?.MainButton?.setText("Отправлено!");
            setTimeout(() => tg?.close?.(), 1500);
        };

        if(tg) {
            tg.MainButton.text = `Отправить ${score} очков`;
            tg.MainButton.color = "#40b345";
            tg.MainButton.show();
            tg.MainButton.onClick(send);
        }
    }

    draw(); drawNext();
    setInterval(() => { if(!gameOver) drop(); }, 800/level);
</script>
</body>
</html>
